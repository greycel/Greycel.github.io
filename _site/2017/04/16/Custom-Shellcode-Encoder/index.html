<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Custom Shellcode Encoder/Decoder (Rolling XOR) &middot; Greycel
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-08 layout-reverse sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Keep Learning..</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    


<!--    <a class="sidebar-nav-item" href="/archive/v.zip">Archive/a> 
    <a class="sidebar-nav-item" href="">GitHub project</a> -->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2017. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Greycel</a>
            <small>Another Security Blog</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Custom Shellcode Encoder/Decoder (Rolling XOR)</h1>
  <span class="post-date">16 Apr 2017</span>
  <p>Lets assume, you’re in middle of a penetration test and were trying to gain access to a machine with Anti-Virus installed. Unfortunatuly, on every attempt you made AV was able to identify and block you from excuting the payload making you drive crazy and frustrating…</p>

<p>Besides the fact that most of the well known encoders are been detected by modern AV and IDS products. In such scenario using of custom encoders would be handy.</p>

<div class="message">
In this article, I'd be creating a custom encoding scheme based on simple XOR Operations called Rolling XOR. this technique could be helful in evading Anti-Virus and Intrusion Detection Systems(IDS) where necessary. 
</div>

<hr />

<p><strong>What is Rolling XOR Encoding Scheme..? </strong></p>

<p>This encoding scheme basically uses a radomly generated key and performs the XOR operation on the first byte in the given array and uses the result as the input(new XOR key) to perform XOR operation with the next consecutive byte and so on.</p>

<h4 id="rolling-xor-python-encoder">Rolling XOR Python Encoder</h4>

<ol>
  <li>Generates a random byte and use it as the base/key to perform the XOR operations.</li>
  <li>Places the generated XOR key as first byte in the new array “xorout_f1/f2”.</li>
  <li>Performs XOR between the first byte in array “xorout_f1/f2” and first byte in “code” variable and append result to new array “xorout_f1/f2”</li>
  <li>This basically takes the result of previous XOR operation as the input(byte) and performs XOR operation with the next byte and same happens with all other bytes.</li>
  <li>Continues the XOR operation till the last byte in “code” variable and final result will be saved in new array “xorout_f1/f2”.</li>
</ol>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#Author: Greycel
</span>
<span class="c">#Website: https://greycel.github.io
</span>
<span class="c">#!/usr/bin/python
</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="s">"</span><span class="se">\xFC\x33\xD2\xB2\x30\x64\xFF\x32\x5A\x8B\x52\x0C\x8B\x52\x14\x8B\x72\x28\x33\xC9\xB1\x18\x33\xFF\x33\xC0\xAC\x3C\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x03\xF8\xE2\xF0\x81\xFF\x5B\xBC\x4A\x6A\x8B\x5A\x10\x8B\x12\x75\xDA\x8B\x53\x3C\x03\xD3\xFF\x72\x34\x8B\x52\x78\x03\xD3\x8B\x72\x20\x03\xF3\x33\xC9\x41\xAD\x03\xC3\x81\x38\x47\x65\x74\x50\x75\xF4\x81\x78\x04\x72\x6F\x63\x41\x75\xEB\x81\x78\x08\x64\x64\x72\x65\x75\xE2\x49\x8B\x72\x24\x03\xF3\x66\x8B\x0C\x4E\x8B\x72\x1C\x03\xF3\x8B\x14\x8E\x03\xD3\x52\x33\xFF\x57\x68\x61\x72\x79\x41\x68\x4C\x69\x62\x72\x68\x4C\x6F\x61\x64\x54\x53\xFF\xD2\x68\x33\x32\x01\x01\x66\x89\x7C\x24\x02\x68\x75\x73\x65\x72\x54\xFF\xD0\x68\x6F\x78\x41\x01\x8B\xDF\x88\x5C\x24\x03\x68\x61\x67\x65\x42\x68\x4D\x65\x73\x73\x54\x50\xFF\x54\x24\x2C\x57\x68\x72\x6c\x64\x2e\x68\x6f\x20\x57\x6f\x68\x48\x65\x6c\x6c\x8B\xDC\x57\x53\x53\x57\xFF\xD0\x68\x65\x73\x73\x01\x8B\xDF\x88\x5C\x24\x03\x68\x50\x72\x6F\x63\x68\x45\x78\x69\x74\x54\xFF\x74\x24\x40\xFF\x54\x24\x40\x57\xFF\xD0</span><span class="s">"</span><span class="p">)</span>

<span class="n">xorout_f1</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="n">xorout_f2</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="n">rand_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
<span class="n">xorout_f1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_key</span><span class="p">)</span>
<span class="n">xorout_f2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_key</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] Random XOR key used: "</span> <span class="s">'0x</span><span class="si">%02</span><span class="s">x'</span> <span class="o">%</span><span class="n">rand_key</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xorout_f1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>  
    <span class="n">j</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">xorout_f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">xorout_f2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">xorout_f1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">xorout_f2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">xorout_f1</span> <span class="o">=</span> <span class="p">(</span><span class="s">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"0x</span><span class="si">%02</span><span class="s">x"</span> <span class="o">%</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">xorout_f1</span><span class="p">))</span>
<span class="n">xorout_f2</span> <span class="o">=</span> <span class="p">(</span><span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x</span><span class="si">%02</span><span class="s">x"</span> <span class="o">%</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">xorout_f2</span><span class="p">))</span>

<span class="k">print</span> <span class="s">"==================================="</span>
<span class="k">print</span> <span class="s">"Total Length: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xorout_f2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s">"bytes"</span>
<span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] Rolling Xor Output F1: </span><span class="se">\n</span><span class="si">%</span><span class="s">s "</span>  <span class="o">%</span><span class="n">xorout_f1</span>
<span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] Rolling Xor Output F2: </span><span class="se">\n</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span><span class="n">xorout_f2</span></code></pre></figure>

<p><img src="/public/rollingXOR_01.jpg" /></p>

<hr />

<h3 id="decoder-stub">Decoder Stub</h3>

<p>Following is our decoder stub which helps us to decode the encoded shellcode. Here we will be using JMP-CALL-POP technique, to get to our encoded shellcode and thereafter we decode the shellcode back to original at runtime and execute it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">;</span> <span class="n">Author</span><span class="p">:</span>   <span class="n">Greycel</span>
<span class="p">;</span> <span class="n">Website</span><span class="p">:</span>  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">greycel</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span> 
<span class="p">;</span> <span class="n">This</span> <span class="n">decodes</span> <span class="n">the</span> <span class="n">encoded</span> <span class="n">Rolling</span> <span class="n">XOR</span> <span class="n">scheme</span> <span class="n">back</span> <span class="n">to</span> <span class="n">its</span> <span class="n">original</span><span class="o">.</span>
<span class="p">;</span> <span class="n">To</span> <span class="n">avoid</span> <span class="n">NULL</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">update</span> <span class="n">the</span> <span class="n">Counter</span> <span class="n">instructions</span> <span class="s">"MOV CL, len"</span><span class="p">,</span> 
<span class="p">;</span>  <span class="s">"DEC CL"</span><span class="p">,</span> <span class="s">"CMP CL,DL"</span> <span class="k">as</span> <span class="n">per</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">code</span> <span class="n">variable</span> <span class="o">.</span>


<span class="k">global</span> <span class="n">_start</span>

<span class="n">section</span> <span class="o">.</span><span class="n">text</span>
<span class="n">_start</span><span class="p">:</span>
        <span class="n">jmp</span> <span class="n">call_code</span>

<span class="n">decoder</span><span class="p">:</span>                   <span class="p">;</span><span class="n">Start</span> <span class="n">of</span> <span class="n">XOR</span> <span class="n">Operation</span>
        <span class="n">POP</span> <span class="n">ESI</span>            <span class="p">;</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">Shellcode</span>
        <span class="n">PUSH</span> <span class="n">ESI</span>           <span class="p">;</span><span class="n">Save</span> <span class="n">pointer</span> <span class="k">for</span> <span class="n">later</span> <span class="n">use</span>
        <span class="n">MOV</span> <span class="n">EDI</span><span class="p">,</span><span class="n">ESI</span>        <span class="p">;</span><span class="n">Copy</span> <span class="n">pointer</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">EDI</span>
        <span class="n">XOR</span> <span class="n">ECX</span><span class="p">,</span><span class="n">ECX</span>        <span class="p">;</span><span class="n">Zeroout</span> <span class="n">the</span> <span class="n">registers</span> <span class="n">ECX</span><span class="p">,</span> <span class="n">EDX</span>
        <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">ECX</span>
        <span class="n">MOV</span> <span class="n">CL</span><span class="p">,</span><span class="nb">len</span>         <span class="p">;</span><span class="n">Setup</span> <span class="n">counter</span> <span class="p">(</span><span class="n">Total</span> <span class="n">Length</span><span class="p">)</span>
<span class="n">loop1</span><span class="p">:</span>
        <span class="n">MOV</span> <span class="n">AL</span><span class="p">,[</span><span class="n">ESI</span><span class="p">]</span>       <span class="p">;</span><span class="n">Take</span> <span class="n">the</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">shellcode</span>
        <span class="n">MOV</span> <span class="n">BL</span><span class="p">,[</span><span class="n">ESI</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>     <span class="p">;</span><span class="n">Take</span> <span class="n">the</span> <span class="n">second</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">shellcode</span>
        <span class="n">XOR</span> <span class="n">AL</span><span class="p">,</span><span class="n">BL</span>          <span class="p">;</span><span class="n">Perform</span> <span class="n">XOR</span> <span class="ow">and</span> <span class="n">save</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">AL</span>
        <span class="n">MOV</span> <span class="p">[</span><span class="n">EDI</span><span class="p">],</span><span class="n">AL</span>       <span class="p">;</span><span class="n">Replace</span> <span class="n">the</span> <span class="n">first</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">EDI</span> <span class="k">with</span> <span class="n">the</span> <span class="n">result</span>
        <span class="n">INC</span> <span class="n">ESI</span>            <span class="p">;</span><span class="n">Increment</span> <span class="n">ESI</span> <span class="ow">and</span> <span class="n">EDI</span>
        <span class="n">INC</span> <span class="n">EDI</span>
        <span class="n">DEC</span> <span class="n">CL</span>                <span class="p">;</span><span class="n">Decrement</span> <span class="n">the</span> <span class="n">Counter</span>
        <span class="n">CMP</span> <span class="n">CL</span><span class="p">,</span><span class="n">DL</span>             <span class="p">;</span><span class="n">Check</span> <span class="k">for</span> <span class="n">condition</span>
        <span class="n">JNZ</span> <span class="n">loop1</span>             <span class="p">;</span><span class="n">Jump</span> <span class="n">to</span> <span class="n">loop1</span> <span class="k">if</span> <span class="n">condition</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">met</span>
        <span class="n">mov</span> <span class="n">byte</span><span class="p">[</span><span class="n">ESI</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mh">0x90</span>  <span class="p">;</span><span class="n">Replace</span> <span class="n">the</span> <span class="n">last</span> <span class="n">trail</span> <span class="n">byte</span> <span class="k">with</span> <span class="n">NOP</span>
        <span class="n">JMP</span> <span class="n">code</span>


<span class="n">call_code</span><span class="p">:</span>
        <span class="n">call</span> <span class="n">decoder</span>
        <span class="n">code</span><span class="p">:</span> <span class="n">db</span> <span class="mh">0xaf</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0xb2</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0xc3</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x9d</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xdb</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0x39</span><span class="p">,</span><span class="mh">0xf0</span>
        
<span class="p">[</span><span class="o">.....</span><span class="p">]</span>

        <span class="mh">0xf4</span><span class="p">,</span><span class="mh">0xf7</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xd2</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0xd9</span><span class="p">,</span><span class="mh">0x9c</span><span class="p">,</span><span class="mh">0xe4</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0xad</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x26</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xe9</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0xda</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0xf5</span>
        <span class="nb">len</span><span class="p">:</span>    <span class="n">equ</span> <span class="err">$</span><span class="o">-</span><span class="n">code</span></code></pre></figure>

<p>Having the above decoder stub ready, with the help of “nasm” compile the assembly code and generate the corresponding object file. Then use the “Objdump” to extract the decoding stub along with encoded shellcode appended to it. For commands to compile and extract shellcode <a href="/2017/04/15/Handy-Commands-ExpDev/">Check</a>.</p>

<p><img src="/public/rollingXOR_decode_stub_out.jpg" /></p>

<hr />

<h3 id="executing-the-shellcode-on-windows">Executing the Shellcode on Windows</h3>

<p>For POC purpose, I’ve used the encoded message box shellcode which would eventually gets decoded at runtime with our decoded stub and executes the Hello World Message Box Popup. Following is our actual decoder stub in debugger without the encoded shellcode</p>

<p><img src="/public/Decoder_Stub_in_DBG.jpg" /></p>

<p>Encoded shellcode within debugger. As per the decoder stub instruction “POP ESI” will pop the address (0x00446028) of encoded shellcode into “ESI” register, which is where the encoded shellcode begins.
<img src="/public/Encoded_Shellcode_in_DBG.jpg" /></p>

<p>By the time the decoder stub completes its execution we will have our actual shellcode ready to be executed from address (0x00446028) which is the beginning of shellcode and continues to execute our payload popping the “Hello World” message box.
<img src="/public/Decoded_Shellcode_in_DBG.jpg" /></p>

<p><img src="/public/Shellcode_execution_in_DBG.jpg" /></p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/04/15/Handy-Commands-ExpDev/">
            Handy Commands for Exploit Development
            <small>15 Apr 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
